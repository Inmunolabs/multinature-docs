# 2.3.3 - Diets API Cleanup Checklist

## Objetivos del Refactor

Este checklist documenta el estado de la simplificaci√≥n arquitect√≥nica del m√≥dulo **diets-api**, centralizando la l√≥gica de generaci√≥n en un pipeline unificado y reduciendo endpoints a solo los esenciales.

---

## ‚úÖ Completado

### üß© Pipeline Unificado

- [x] **Pipeline centralizado** en `src/services/pipeline.js`
  - [x] Funci√≥n `computeEnergy()` implementada
  - [x] Funci√≥n `resolveMacros()` implementada
  - [x] Funci√≥n `buildSchedule()` implementada
  - [x] Funci√≥n `applyEquivalences()` implementada
  - [x] Funci√≥n `generateDishes()` implementada
  - [x] Helper `runFullPipeline()` implementado

### üîå Endpoints Principales

- [x] **GET /diets/generate-automatic/:userId** activo
  - [x] Usa pipeline unificado
  - [x] Selecci√≥n autom√°tica de f√≥rmulas y par√°metros
  - [x] Sin body requerido (todos los params se derivan)
  
- [x] **POST /diets/:dietId/actions** implementado
  - [x] Orquestador sin persistencia
  - [x] Soporte para ejecuci√≥n parcial del pipeline
  - [x] Formato de respuesta: `{ folio, message, content }`
  - [x] Validaciones de steps y dependencias autom√°ticas

### üìö Documentaci√≥n

- [x] **README.md** actualizado con contrato pragm√°tico
  - [x] Secci√≥n "Contrato Pragm√°tico de los Endpoints"
  - [x] Referencia a `doc/response-actual.json`
  - [x] Ejemplos de uso GET y POST

- [x] **Endpoints/generate-automatic.md** actualizado
  - [x] Refleja GET como m√©todo principal
  - [x] Documenta compatibilidad POST (legacy)
  - [x] Incluye secci√≥n de Pipeline Unificado

- [x] **Endpoints/diet-actions.md** creado
  - [x] Ejemplos de pipeline completo
  - [x] Ejemplos de solo macros
  - [x] Ejemplos de solo schedule
  - [x] Ejemplos de solo equivalences
  - [x] Ejemplos de solo dishes
  - [x] Formato de respuesta documentado

- [x] **Guides/2.3.2-diet-pipeline-and-actions.md** creado
  - [x] Documentaci√≥n detallada por tramo
  - [x] Ejemplos concretos de input/output
  - [x] Overrides disponibles
  - [x] Gu√≠as de debugging y testing

- [x] **Guides/2.3.3-diets-api-cleanup-checklist.md** creado (este archivo)

### üóëÔ∏è Endpoints Legacy

- [x] Verificaci√≥n de endpoints legacy
  - [x] `/macronutrients` - **NO EXISTE** en c√≥digo actual
  - [x] `/portions` - **NO EXISTE** en c√≥digo actual
  - [x] `/plates` - **NO EXISTE** en c√≥digo current

**Conclusi√≥n:** No hay endpoints legacy que eliminar. Probablemente ya fueron removidos en refactors anteriores.

---

## üîÑ En Progreso / Futuro

### üß™ Testing

- [ ] Tests unitarios para cada tramo del pipeline
  - [ ] `computeEnergy.test.js`
  - [ ] `resolveMacros.test.js`
  - [ ] `buildSchedule.test.js`
  - [ ] `applyEquivalences.test.js`
  - [ ] `generateDishes.test.js`

- [ ] Tests de integraci√≥n para pipeline completo
  - [ ] `runFullPipeline.test.js`

- [ ] Tests de endpoints
  - [ ] `GET /generate-automatic/:userId`
  - [ ] `POST /actions` con diferentes steps

### üîç Limpieza de C√≥digo

- [ ] Identificar y eliminar c√≥digo sin referencias
  - [ ] Revisar `src/services/` para funciones obsoletas
  - [ ] Revisar `src/nutrition/` para helpers no utilizados
  - [ ] Revisar `src/utils/` para utilidades duplicadas

- [ ] Consolidar importaciones duplicadas
  - [ ] Auditar imports en `generate.js`
  - [ ] Auditar imports en `pipeline.js`

### üìä M√©tricas y Monitoreo

- [ ] Agregar logs de performance por tramo
- [ ] Instrumentar tiempos de ejecuci√≥n
- [ ] Dashboard de uso de endpoints (GET vs POST)

### üöÄ Optimizaciones

- [ ] Cache de resultados de `buildSchedule()` (por userId)
- [ ] Cache de `applyEquivalences()` (por macros)
- [ ] Paralelizaci√≥n de queries en `generateDishes()`

### üìñ Documentaci√≥n Adicional

- [ ] Agregar ejemplos de curl a README principal
- [ ] Documentar casos de error comunes
- [ ] Crear gu√≠a de migraci√≥n para clientes existentes

---

## üìã Validaciones Post-Refactor

### ‚úì Checklist de Validaci√≥n

Ejecutar las siguientes validaciones para confirmar que el refactor no rompi√≥ funcionalidad existente:

#### 1. Endpoints Funcionando

```bash
# Test GET /generate-automatic
curl -X GET http://localhost:3000/diets/generate-automatic/USER_UUID \
  -H "Authorization: Bearer TOKEN"

# Test POST /actions (solo macros)
curl -X POST http://localhost:3000/diets/DIET_UUID/actions \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"steps": ["resolveMacros"]}'

# Test POST /actions (pipeline completo)
curl -X POST http://localhost:3000/diets/DIET_UUID/actions \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"steps": ["computeEnergy", "resolveMacros", "buildSchedule", "applyEquivalences", "generateDishes"]}'
```

#### 2. Formato de Respuesta

- [ ] Verificar que GET /generate-automatic devuelve `{ success, data: { content: [...] } }`
- [ ] Verificar que POST /actions devuelve `{ success, data: { folio, message, content } }`
- [ ] Verificar estructura de `menus ‚Üí meals ‚Üí dishes`

#### 3. Validaciones de Negocio

- [ ] Plan siempre de 7 d√≠as (keys 0..6)
- [ ] Justificaciones en 1 p√°rrafo (4-6 oraciones) con datos cl√≠nicos
- [ ] Tiempos de comida derivados correctamente
- [ ] Macros suman correctamente al GET
- [ ] Porciones SMAE balancean macros (¬±10%)

#### 4. Compatibilidad Retroactiva

- [ ] POST /generate-automatic (legacy) sigue funcionando
- [ ] Endpoints de menus (/menus/*) no afectados
- [ ] Endpoints SMAE (/smae/*) no afectados

---

## üêõ Issues Conocidos

### Issue #1: Validaci√≥n de portionBalance puede fallar en casos extremos

**Descripci√≥n:** Para dietas muy bajas en calor√≠as (<1200 kcal), el balance de porciones SMAE puede desviarse >10%.

**Workaround:** Ajustar manualmente macros mediante overrides en POST /actions.

**Estado:** En revisi√≥n

---

### Issue #2: Tiempo de ejecuci√≥n de generateDishes puede ser lento

**Descripci√≥n:** Para 7 d√≠as x 4 comidas = 28 meals, las queries a `foods` y `foods_ingredients` pueden ser lentas (~2-3s).

**Workaround:** Implementar cache en buildDishesFromPortions.

**Estado:** Optimizaci√≥n planeada

---

## üìù Notas de Migraci√≥n

### Para Clientes Existentes

Si actualmente usas **POST /generate-automatic** con body expl√≠cito:

**Opci√≥n 1: Migrar a GET (recomendado)**

```bash
# Antes
POST /diets/generate-automatic
Body: { userId, formulas, CAF, ETA, AF }

# Despu√©s
GET /diets/generate-automatic/:userId
(sin body - todo se deriva autom√°ticamente)
```

**Opci√≥n 2: Mantener POST (legacy)**

El endpoint POST sigue funcionando sin cambios. No requiere migraci√≥n inmediata.

---

### Para Integraciones con Frontend

**Cambios en response format:**

- Campo `mealPlan` ‚Üí `menus`
- Campo `dailyDistribution` ‚Üí `portionDistribution`
- Estructura `menus[].meals[].dishes` (nuevo)
- `content` ahora es un objeto de dieta (ya no existe `content[]`)
- `recommendedGET` solo expone `value`, `source` y `justification` (sin `rationale`)

**Ejemplo de migraci√≥n:**

```javascript
// Antes
const mealPlan = response.data.mealPlan['0'];

// Despu√©s
const day0Menu = response.content.menus.items[0];
const day0Meals = day0Menu.meals;
```

---

## üéØ Criterios de Aceptaci√≥n

Para considerar el refactor **completamente finalizado**, verificar:

- [x] Pipeline centralizado en `src/services/pipeline.js`
- [x] Endpoints GET y POST funcionando
- [x] Documentaci√≥n completa (README, Endpoints, Guides)
- [ ] Tests unitarios y de integraci√≥n pasando
- [ ] Validaciones de negocio cumplidas
- [ ] Performance acceptable (<3s para pipeline completo)
- [ ] Sin regresiones en endpoints existentes

---

## üìÖ Historial de Cambios

### 2025-11-03 - Refactor Inicial

- ‚úÖ Creaci√≥n de pipeline unificado
- ‚úÖ Implementaci√≥n de POST /actions
- ‚úÖ Documentaci√≥n de endpoints y gu√≠as
- ‚úÖ Actualizaci√≥n de README principal

### Pr√≥ximos Pasos

1. Implementar tests (unitarios e integraci√≥n)
2. Optimizar performance de generateDishes
3. Agregar cache para tramos costosos
4. Documentar casos de error comunes

---

## üîó Referencias

- **Pipeline Implementation**: `src/services/pipeline.js`
- **Actions Service**: `src/services/dietActions.js`
- **Routes**: `src/routes/diets.js`
- **Docs**: `docs/01_Backend/APIs/diets-api/`

---

## ‚ú® Logros del Refactor

### Antes

- üî¥ L√≥gica de generaci√≥n dispersa en m√∫ltiples servicios
- üî¥ Endpoint POST con body complejo obligatorio
- üî¥ No hab√≠a forma de ejecutar tramos parciales
- üî¥ Documentaci√≥n desactualizada

### Despu√©s

- ‚úÖ Pipeline centralizado y modular
- ‚úÖ Endpoint GET simple sin body
- ‚úÖ Orquestador flexible para ajustes y pruebas
- ‚úÖ Documentaci√≥n completa y actualizada
- ‚úÖ C√≥digo m√°s mantenible y testeable

---

**√öltima actualizaci√≥n:** 2025-11-03

