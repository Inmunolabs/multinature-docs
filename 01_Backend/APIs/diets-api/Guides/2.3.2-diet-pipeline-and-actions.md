# 2.3.2 - Diet Pipeline and Actions

## Introducción

El **pipeline unificado** de generación de dietas centraliza toda la lógica de cálculo en 5 tramos secuenciales y reutilizables. Este diseño permite:

- **Consistencia**: Mismo código para GET /generate-automatic y POST /actions
- **Modularidad**: Cada tramo es independiente y testeable
- **Flexibilidad**: Ejecución parcial o completa según necesidad
- **Trazabilidad**: Resultados intermedios inspeccionables

## Ubicación del Código

**Implementación**: `apis/diets-api/src/services/pipeline.js`

Funciones exportadas:
- `computeEnergy(context, overrides)`
- `resolveMacros(context, overrides)`
- `buildSchedule(context, overrides)`
- `applyEquivalences(context, overrides)`
- `generateDishes(context, overrides)`
- `runFullPipeline(context, overrides)` _(helper para ejecutar todos los tramos)_

---

## Pipeline Overview

```
┌─────────────────────┐
│  1. computeEnergy   │ → Calcula GET desde DietCalculator
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  2. resolveMacros   │ → Distribuye macronutrientes
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  3. buildSchedule   │ → Deriva tiempos de comida
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 4. applyEquivalen.  │ → Calcula porciones SMAE
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  5. generateDishes  │ → Construye platillos multi-dish
└─────────────────────┘
```

---

## Tramo 1: computeEnergy

### Propósito

Calcula el **Gasto Energético Total (GET)** recomendado usando DietCalculator y aplica ajustes según el objetivo del paciente.

### Dependencias

Ninguna (puede ejecutarse independientemente)

### Input Context

```javascript
{
  patientData: {
    age: 35,
    gender: 'M',
    weight: 75,
    height: 175,
    objective: 'Bajar de peso'
  },
  calculateData: {
    CAF: 1.4,
    ETA: 10,
    AF: 0,
    AGA: {}
  },
  formulas: ['mifflinStJeor', 'harrisBenedict']
}
```

### Output

```javascript
{
  value: 1870,                    // GET final (kcal/día)
  source: 'DietCalculator',
  baseGet: 2200,                  // GET sin ajuste
  profile: {
    key: 'loss',
    caloricFactor: 0.85,          // -15% para pérdida
    macroDistribution: {
      protein: 0.3,
      fat: 0.3,
      carbs: 0.4
    },
    label: 'deficit moderado (-15%)'
  },
  adjustmentKcal: -330,
  adjustmentPercent: -15,
  rationale: 'GET calculado mediante Mifflin-St Jeor y Harris Benedict para paciente de 35 años, 75 kg, 175 cm (IMC 24.5), sexo M y factor de actividad 1.40, con ajuste de -15% por objetivo "Bajar de peso" según protocolo SMAE, resultando en 1870 kcal/día.',
  justification: '...',           // Alias de rationale
  calculationResult: {            // DietCalculator raw output
    GET: 2200,
    formulaResults: [...],
    averageCalories: 1650,
    ETACalories: 165,
    AFCalories: 0
  }
}
```

### Overrides Disponibles

```javascript
// Override del GET calculado
const overrides = {
  recommendedGet: 2000  // Forzar GET específico
};
```

### Ejemplo de Uso

```javascript
import { computeEnergy } from './pipeline.js';

const context = {
  patientData: { age: 35, gender: 'M', weight: 75, height: 175, objective: 'Bajar de peso' },
  calculateData: { CAF: 1.4, ETA: 10, AF: 0, AGA: {} },
  formulas: ['mifflinStJeor', 'harrisBenedict']
};

const energyTargets = computeEnergy(context);
console.log('GET recomendado:', energyTargets.value); // 1870
console.log('Ajuste:', energyTargets.adjustmentPercent); // -15
```

---

## Tramo 2: resolveMacros

### Propósito

Distribuye el GET en macronutrientes (proteínas, grasas, carbohidratos) según el perfil de objetivo.

### Dependencias

Requiere resultado de `computeEnergy`

### Input Context

```javascript
{
  energyTargets: {  // Output de computeEnergy
    value: 1870,
    profile: {
      macroDistribution: { protein: 0.3, fat: 0.3, carbs: 0.4 }
    }
  },
  patientData: { ... }
}
```

### Output

```javascript
{
  proteinsPerDay: 140,       // gramos/día
  lipidsPerDay: 62,          // gramos/día
  carbohydratesPerDay: 187,  // gramos/día
  justification: 'Distribucion 30% proteina (~140 g), 30% grasa (~62 g) y 40% carbohidratos (~187 g) alineada a SMAE y meta deficit moderado (-15%).',
  calories: {
    protein: 560,    // kcal desde proteína
    fat: 560,        // kcal desde grasa
    carbs: 748       // kcal desde carbohidratos
  }
}
```

### Overrides Disponibles

```javascript
// Override de macros individuales
const overrides = {
  proteinsPerDay: 160,       // Forzar proteínas específicas
  lipidsPerDay: 55,          // Forzar grasas específicas
  carbohydratesPerDay: 180,  // Forzar carbohidratos específicos
  macroDistribution: {       // O bien, cambiar distribución
    protein: 0.35,
    fat: 0.25,
    carbs: 0.4
  }
};
```

### Ejemplo de Uso

```javascript
import { computeEnergy, resolveMacros } from './pipeline.js';

const context = { /* ... */ };
const energyTargets = computeEnergy(context);
context.energyTargets = energyTargets;

const macroTargets = resolveMacros(context);
console.log('Proteínas:', macroTargets.proteinsPerDay); // 140g
console.log('Grasas:', macroTargets.lipidsPerDay); // 62g
console.log('Carbohidratos:', macroTargets.carbohydratesPerDay); // 187g
```

---

## Tramo 3: buildSchedule

### Propósito

Deriva los **tiempos de comida** y **estructura de meals** desde el contexto del paciente (edad, ocupación, horarios laborales).

### Dependencias

Ninguna (puede ejecutarse independientemente)

### Input Context

```javascript
{
  patientData: {
    userId: 'uuid',
    age: 35,
    occupation: 'Empleado de oficina',
    workSchedule: '9am-6pm',
    lifestyle: 'office_worker'
  },
  clinicalData: { ... }  // Formularios clínicos del paciente
}
```

### Output

```javascript
{
  days: 7,  // HARD REQUIREMENT: siempre 7
  mealsPerDay: 4,
  mealTypes: ['Desayuno', 'Colacion', 'Comida', 'Cena'],
  mealTimes: {
    Desayuno: '07:30',
    Colacion: '10:30',
    Comida: '13:30',
    Cena: '19:30'
  },
  justifications: {
    daysJustification: 'Plan de 7 días para asegurar variedad y adherencia.',
    mealsJustification: 'Estructura de 4 tiempos de comida adaptada al estilo de vida del paciente.'
  }
}
```

### Overrides Disponibles

```javascript
// Override de tiempos de comida o tipos
const overrides = {
  mealTypes: ['Desayuno', 'Comida', 'Cena'],  // Solo 3 comidas
  mealTimes: {                                 // Horarios personalizados
    Desayuno: '06:00',
    Comida: '12:00',
    Cena: '18:00'
  }
};
```

### Ejemplo de Uso

```javascript
import { buildSchedule } from './pipeline.js';

const context = {
  patientData: {
    userId: 'uuid',
    age: 35,
    occupation: 'Empleado de oficina',
    workSchedule: '9am-6pm',
    lifestyle: 'office_worker'
  },
  clinicalData: {}
};

const mealStructure = await buildSchedule(context);
console.log('Horarios:', mealStructure.mealTimes);
// { Desayuno: '07:30', Colacion: '10:30', Comida: '13:30', Cena: '19:30' }
```

---

## Tramo 4: applyEquivalences

### Propósito

Convierte macronutrientes objetivo en **porciones SMAE** por tiempo de comida, distribuidas para 7 días.

### Dependencias

Requiere resultados de `resolveMacros` y `buildSchedule`

### Input Context

```javascript
{
  macroTargets: {
    proteinsPerDay: 140,
    lipidsPerDay: 62,
    carbohydratesPerDay: 187
  },
  mealStructure: {
    mealTypes: ['Desayuno', 'Colacion', 'Comida', 'Cena'],
    mealTimes: { Desayuno: '07:30', Colacion: '10:30', Comida: '13:30', Cena: '19:30' }
  }
}
```

### Output

```javascript
{
  '0': [  // Día 0 (lunes)
    {
      meal: 'Desayuno',
      time: '07:30',
      items: [
        { group: 'AOA', portions: 2.5 },
        { group: 'Cereal', portions: 2 },
        { group: 'Fruta', portions: 1 },
        { group: 'Grasa', portions: 1 }
      ],
      justification: ''
    },
    {
      meal: 'Colacion',
      time: '10:30',
      items: [
        { group: 'Fruta', portions: 1 },
        { group: 'Leche', portions: 1 }
      ],
      justification: ''
    },
    // ... Comida, Cena
  ],
  '1': [ /* ... día 1 ... */ ],
  // ... días 2-6
  totalPortions: 42  // Total de porciones SMAE en la semana
}
```

### Overrides Disponibles

```javascript
// Override completo de portionDistribution
const overrides = {
  portionDistribution: {
    '0': [
      {
        meal: 'Desayuno',
        time: '07:30',
        items: [
          { group: 'AOA', portions: 3 },  // Más proteína
          { group: 'Cereal', portions: 1 }
        ]
      }
    ],
    totalPortions: 35
  }
};
```

### Ejemplo de Uso

```javascript
import { applyEquivalences } from './pipeline.js';

const context = {
  macroTargets: { proteinsPerDay: 140, lipidsPerDay: 62, carbohydratesPerDay: 187 },
  mealStructure: {
    mealTypes: ['Desayuno', 'Colacion', 'Comida', 'Cena'],
    mealTimes: { /* ... */ }
  }
};

const portionDistribution = applyEquivalences(context);
console.log('Total porciones:', portionDistribution.totalPortions); // 42
console.log('Día 0:', portionDistribution['0']);
```

---

## Tramo 5: generateDishes

### Propósito

Construye **dishes multi-plato** desde porciones SMAE, consultando la base de datos de alimentos reales.

### Dependencias

Requiere resultados de `applyEquivalences` y `buildSchedule`

### Input Context

```javascript
{
  portionDistribution: {
    '0': [
      {
        meal: 'Desayuno',
        time: '07:30',
        items: [
          { group: 'AOA', portions: 2.5 },
          { group: 'Cereal', portions: 2 }
        ]
      }
    ]
  },
  mealStructure: {
    mealTypes: ['Desayuno', 'Colacion', 'Comida', 'Cena']
  },
  specialistId: 'uuid'
}
```

### Output

```javascript
[
  {
    menuId: '',
    menuName: '',
    notes: '',
    dietId: '',
    specialistId: 'uuid',
    assignedDays: [0],
    meals: [
      {
        menuMealId: 'uuid',
        mealTime: '07:30:00',
        mealType: 'Desayuno',
        dishes: [
          {
            id: 'dish-uuid-1',
            name: 'Omelette de claras',
            type: 'food',
            foodId: 1023,
            option: 0,
            quantity: 1,
            ingredients: [
              {
                ingredientId: 501,
                name: 'Clara de huevo',
                grams: 100,
                unit: 'g'
              }
            ],
            ingredientsTotalGrams: 100
          },
          {
            id: 'dish-uuid-2',
            name: 'Avena cocida',
            type: 'food',
            foodId: 2045,
            option: 0,
            quantity: 1,
            ingredients: [
              {
                ingredientId: 601,
                name: 'Avena en hojuelas',
                grams: 40,
                unit: 'g'
              }
            ],
            ingredientsTotalGrams: 40
          }
        ],
        equivalences: [],
        macros: {
          energyKcal: 450,
          proteinGrams: 35,
          carbohydratesGrams: 50,
          lipidsGrams: 8
        },
        justification: 'Desayuno equilibrado con proteína de alta calidad desde las claras de huevo y carbohidratos complejos de la avena, ideal para iniciar el día con energía sostenida.'
      }
    ]
  }
]
```

### Overrides Disponibles

No disponibles (este tramo consulta DB real basándose en portionDistribution)

### Ejemplo de Uso

```javascript
import { generateDishes } from './pipeline.js';

const context = {
  portionDistribution: { /* ... */ },
  mealStructure: { /* ... */ },
  specialistId: 'uuid'
};

const menus = await generateDishes(context);
console.log('Menus generados:', menus.length); // 7 (uno por día)
console.log('Dishes día 0:', menus[0].meals[0].dishes);
```

---

## Ejecución Completa del Pipeline

### Usando runFullPipeline

```javascript
import { runFullPipeline } from './pipeline.js';

const context = {
  userId: 'uuid',
  specialistId: 'uuid',
  patientData: { age: 35, gender: 'M', weight: 75, height: 175, objective: 'Bajar de peso' },
  calculateData: { CAF: 1.4, ETA: 10, AF: 0, AGA: {} },
  formulas: ['mifflinStJeor', 'harrisBenedict'],
  clinicalData: {}
};

const overrides = {
  resolveMacros: {
    proteinsPerDay: 160  // Override solo macros
  }
};

const result = await runFullPipeline(context, overrides);

console.log('Energía:', result.energyTargets.value);
console.log('Macros:', result.macroTargets);
console.log('Horarios:', result.mealStructure.mealTimes);
console.log('Porciones:', result.portionDistribution.totalPortions);
console.log('Menus:', result.menus.length);
```

---

## Uso en Endpoints

### GET /generate-automatic/:userId

Ejecuta **pipeline completo** sin overrides:

```javascript
const result = await runFullPipeline(context, {});
```

### POST /actions

Ejecuta **pipeline parcial** según `steps` solicitados:

```javascript
// Solo macros
const energyTargets = computeEnergy(context, overrides.computeEnergy || {});
context.energyTargets = energyTargets;
const macroTargets = resolveMacros(context, overrides.resolveMacros || {});
```

---

## Validaciones Automáticas

Cada tramo incluye validaciones internas:

### computeEnergy
- Clamp GET entre 1200-4500 kcal
- Validación de fórmulas válidas
- Fallback a 1600 kcal si cálculo falla

### resolveMacros
- Validación de distribución suma 100%
- Macros mínimos: 0.5g proteína/kg, 0.8g grasa/kg

### buildSchedule
- Siempre 7 días (HARD REQUIREMENT)
- Horarios válidos (HH:MM)

### applyEquivalences
- Balance energético ±10%
- Porciones mínimas por grupo SMAE

### generateDishes
- Validación de items (mínimo 1 por meal)
- Macros recalculados desde dishes reales

---

## Testing

### Test Unitario por Tramo

```javascript
import { computeEnergy } from './pipeline.js';

describe('computeEnergy', () => {
  it('should calculate GET with deficit for weight loss', () => {
    const context = {
      patientData: { objective: 'Bajar de peso', age: 35, gender: 'M', weight: 75, height: 175 },
      calculateData: { CAF: 1.4, ETA: 10, AF: 0 },
      formulas: ['mifflinStJeor']
    };
    
    const result = computeEnergy(context);
    
    expect(result.value).toBeLessThan(result.baseGet);
    expect(result.profile.key).toBe('loss');
    expect(result.adjustmentPercent).toBe(-15);
  });
});
```

### Test de Integración

```javascript
import { runFullPipeline } from './pipeline.js';

describe('Full Pipeline', () => {
  it('should generate complete diet plan', async () => {
    const context = { /* ... */ };
    
    const result = await runFullPipeline(context);
    
    expect(result.energyTargets.value).toBeGreaterThan(0);
    expect(result.macroTargets.proteinsPerDay).toBeGreaterThan(0);
    expect(result.mealStructure.days).toBe(7);
    expect(result.portionDistribution.totalPortions).toBeGreaterThan(0);
    expect(result.menus).toHaveLength(7);
  });
});
```

---

## Debugging

### Habilitar Logs Detallados

Cada tramo incluye logs internos con prefijo `[nombreTramo]`:

```
[computeEnergy] Computing energy for patient: { age: 35, gender: 'M', ... }
[computeEnergy] ✅ Energy computed: 1870 kcal/day
[resolveMacros] ✅ Macros resolved: { proteinsPerDay: 140, ... }
[buildSchedule] Deriving meal times for 4 meals...
[buildSchedule] ✅ Schedule built: { Desayuno: '07:30', ... }
[applyEquivalences] Deriving SMAE portions from macros...
[applyEquivalences] ✅ Equivalences applied - Total portions: 42
[generateDishes] Building dishes from portions for 7 days...
[generateDishes] ✅ Dishes generated for 7 menus
```

### Inspeccionar Contexto Intermedio

```javascript
const context = { /* ... */ };

const energyTargets = computeEnergy(context);
console.log('Step 1:', energyTargets);

context.energyTargets = energyTargets;
const macroTargets = resolveMacros(context);
console.log('Step 2:', macroTargets);

// ... etc
```

---

## Troubleshooting

### Error: "Missing required context"

**Causa:** Tramo ejecutado sin dependencias previas

**Solución:** Ejecutar tramos dependientes primero o usar `runFullPipeline`

### Error: "Portion balance validation failed"

**Causa:** Porciones SMAE no cierran balance energético

**Solución:** Ajustar macros o revisar configuración de SMAE

### Error: "No dishes generated for meal"

**Causa:** No hay alimentos disponibles para grupo SMAE solicitado

**Solución:** Verificar disponibilidad en tabla `foods` y `equivalences_groups`

---

## Referencias

- **Implementación**: `apis/diets-api/src/services/pipeline.js`
- **Endpoint Actions**: `Endpoints/diet-actions.md`
- **Endpoint Generate**: `Endpoints/generate-automatic.md`
- **SMAE Portions**: `apis/diets-api/src/nutrition/portions.js`
- **Dishes Builder**: `apis/diets-api/src/nutrition/dishes.js`

