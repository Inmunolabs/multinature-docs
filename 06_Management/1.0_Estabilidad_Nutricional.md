# 1.0 Estabilidad Nutricional ‚Äì Documento Completo

## üéØ Objetivo

Garantizar la **estabilidad total del m√≥dulo nutricional**, eliminando inconsistencias, normalizando SMAE, corrigiendo porciones, unificando GET/CAF/AF y asegurando un DietAgent cl√≠nicamente coherente.

---

# 1. EPICAS PRINCIPALES

## ‚úÖ 1.1. SMAE ‚Äì Auditor√≠a y Correcci√≥n

### Problemas actuales

- Datos corruptos o inconsistentes en varios platillos.
- Equivalentes que no corresponden a grupos reales.
- Recipes incompletas o con conversiones rotas.

### Entregables

- Auditor√≠a completa del cat√°logo SMAE.
- Correcci√≥n de platillos con inconsistencias graves.
- Carga del cat√°logo en startup.
- Validaci√≥n y logging cuando se usen valores por default.

### Tareas

- [ ] Script de auditor√≠a SMAE. (Identificaci√≥n de platillos con valores fuera de rango.)
- [ ] Reparaci√≥n manual de platillos rotos de SMAE.
- [ ] Crear logger de fallbacks y densidades por default.
- [ ] Documentar estructura final de SMAE.

---

## ‚úÖ 1.2. MealTimes ‚Äì Normalizaci√≥n Global

### Problemas

- Inconsistencias por entorno (men√∫s IA vs men√∫s manuales).
- Horarios no alineados con consumo real.
- La IA produce horarios fuera de orden (ej. cena 13:30).

### Entregables

- Diccionario √∫nico de mealTimes v√°lido.
- Validaci√≥n autom√°tica del orden.
- Ajuste de mealTimes en IA + formularios + men√∫ manual.

### Tareas

- [ ] Definir est√°ndar final de mealTimes. Desayuno ‚Üí ¬øColaci√≥n? ‚Üí Comida ‚Üí ¬øColaci√≥n? ‚Üí Cena ‚Üí ¬øColaci√≥n?
- [ ] Normalizar consumo interno en DietAgent.
- [ ] Ajustar rutas (`menus.js`, `diets.js`, `dto`, `transformMealPlanToMenus`).
- [ ] Validaci√≥n autom√°tica ‚ÄúmealTimes desordenados‚Äù.
- [ ] Documentaci√≥n para frontend.

---

## ‚úÖ 1.3. Porciones IA ‚Äì Correcci√≥n y Validaci√≥n

### Problemas

- La IA produce porciones inconsistentes.
- Equivalentes no suman correctamente.
- Restas de calor√≠as incorrectas.
- Ajuste de equivalentes que no respeta l√≠mites por comida.

### Entregables

- C√°lculo robusto de porciones.
- Validaciones por macronutriente.
- L√≠mites por comida y por d√≠a.
- Logging de desviaciones.

### Tareas

- [ ] Redise√±ar l√≥gica de asignaci√≥n de porciones.
- [ ] Validar equivalentes y totales. (Que equivalentes sumen los requerimientos del paciente.)
- [ ] Verificar l√≠mites por comida.
- [ ] Validar que la IA no genere porciones menores a 0.1.
- [ ] Ajustar colaciones.
- [ ] Logging en cada paso.

---

## ‚úÖ 1.4. GET / CAF / AF ‚Äì Unificaci√≥n y Coherencia

### Problemas

- Uso incorrecto o duplicado de AF vs CAF.
- GET mal calculado en funci√≥n de f√≥rmulas.
- Falta de claridad cl√≠nica en el c√°lculo.
- Input de actividad f√≠sica disperso en formularios.

### Entregables

- F√≥rmula GET unificada y documentada.
- Uso √∫nico de CAF/AF en toda la cadena.
- Validaci√≥n cl√≠nica robusta.
- Logging de inputs originales del usuario y ajustes por IA.

### Tareas

- [ ] Revisar f√≥rmulas Harris/Mifflin/Schofield.
- [ ] Integrar CAF √∫nico. (Unificar nombre en todo el sistema.)
- [ ] Validar inputs desde formulario cl√≠nico.
- [ ] Documentar GET completo.
- [ ] Agregar logs de desviaciones.

---

# 2. DEPENDENCIAS

1. **SMAE** debe estar listo antes de porciones.
2. **CAF/AF** debe estar listo antes de GET.
3. **MealTimes** debe estar listo antes de menus IA.
4. **GET** debe estar listo antes de justificaciones IA.
5. **Justificaciones IA** dependen de GET y porciones.

---

# 3. ASIGNACI√ìN SUGERIDA POR ROL

## Samuel

- SMAE auditor√≠a
- Normalizador
- GET/CAF/AF unificaci√≥n
- MealTimes backend

## Miguel

- Arquitectura de SMAE Cache
- Validaciones GET
- Logging avanzado
- Ajuste de transformadores IA

## Erick

- Soporte porciones IA
- Testing manual con Leo

## Cristopher

- Validaciones mealTimes
- Limpieza de DTOs

## Diego

- Ajustes frontend mealTimes
- Ajustes de visualizaci√≥n equivalentes

## Leo

- Matriz de pruebas (SMAE + mealTimes + porciones + GET)

---

# 4. STORY POINTS (ESTIMACI√ìN)

| √âpica        | SP  |
| ------------ | --- |
| SMAE         | 34  |
| MealTimes    | 14  |
| Porciones IA | 32  |
| GET/CAF/AF   | 20  |

Total: **101 SP**

---

# 5. HORAS TOTALES ESTIMADAS

| Rol        | Horas |
| ---------- | ----- |
| Samuel     | 65h   |
| Miguel     | 40h   |
| Erick      | 28h   |
| Cristopher | 22h   |
| Diego      | 10h   |
| Leo        | 15h   |

Total: **180h aprox.**

---

# 6. ENTREGA ESPERADA POR SPRINT

## Sprint 1 ‚Äî Beta Final

- SMAE completo
- MealTimes estable
- GET/CAF/AF unificado
- Porciones corregidas (base)
- Validaciones b√°sicas

## Sprint 2 ‚Äî Refinamiento hacia 1.0

- Validaciones completas
- Logging
- Ajustes finos del DietAgent
- Justificaciones cl√≠nicas con inputs correctos

---

# 7. RIESGOS

- SMAE roto m√°s profundo de lo esperado.
- GET depende de inputs cl√≠nicos a veces incompletos.
- Porciones IA requieren iteraci√≥n.
- MealTimes actual puede romper historial previo.

---

# 8. DOCUMENTACI√ìN FINAL ESPERADA

- `/doc/smae_overhaul.md`
- `/doc/get-calculation.md`
- `/doc/mealTimes-standard.md`
- `/doc/portioning-rules.md`

---

# 9. RECOMENDACI√ìN FINAL

Este m√≥dulo debe cerrarse **antes de tocar men√∫s IA o CRUDs**, porque todo lo dem√°s depende de esta base.
