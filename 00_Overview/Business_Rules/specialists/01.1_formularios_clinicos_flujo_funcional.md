# 01.1 ‚Äì Formularios cl√≠nicos: flujo funcional y uso pr√°ctico

> Documento complementario a: **[01_formularios_clinicos_rules.md](./01_formularios_clinicos_rules.md)**  
> Este archivo describe el flujo funcional del sistema de formularios cl√≠nicos de Multinature, desde la creaci√≥n del template hasta la captura y versionado de formularios llenados.

---

## üß≠ FLUJO GENERAL: de template a formulario llenado

### Escenario base

- La especialista **Dra. Ana**, nutri√≥loga, crea una plantilla personalizada de formulario cl√≠nico.
- Cuando un paciente llega a consulta, ella selecciona esa plantilla y **llena los datos del paciente** bas√°ndose en los conceptos definidos previamente.

### 1Ô∏è‚É£ Creaci√≥n del template (una sola vez por especialista o plantilla)

La Dra. Ana crea un nuevo template que llama:

**‚ÄúEvaluaci√≥n - Adultos‚Äù**

Y define los siguientes conceptos dentro del template:

| Concepto         | Unidad | Graficable | Observaci√≥n |
| ---------------- | ------ | ---------- | ----------- |
| Peso             | kg     | ‚úÖ         |             |
| Estatura         | cm     | ‚ùå         |             |
| % Grasa corporal | %      | ‚úÖ         |             |
| Cintura          | cm     | ‚úÖ         |             |

Este template se guarda en:

- `form_templates` ‚Üí nombre: ‚ÄúEvaluaci√≥n - Adultos‚Äù, `specialist_id` = Dra. Ana
- Cada campo se guarda en `form_template_concepts` (uno por cada concepto), relacion√°ndolo con el template, ya sea mediante `concept_id` (si viene del cat√°logo) o `custom_name` si es un campo personalizado.

---

### 2Ô∏è‚É£ Alta de cita y llenado del formulario

Supongamos que llega el paciente **Carlos P√©rez** el 1 de abril. La Dra. Ana:

1. Si no existe, crea una nueva cita (`booking`), de lo contrario selecciona la cita del paciente.
2. Selecciona el template ‚ÄúEvaluaci√≥n - Adultos‚Äù.
3. Llena los campos uno a uno desde ese template:
   - Peso: `72 kg`
   - Estatura: `1.70 m`
   - % Grasa: `22 %`
   - Cintura: `90 cm`
4. Guarda el formulario.

Esto genera:

- Un nuevo registro en `filled_forms`, relacionado con la cita (`booking_id`).
- Un conjunto de registros en `filled_form_values`, uno por cada campo capturado, copiando:
  - El nombre del concepto (`concept_name`).
  - El valor (`value`), unidad (`unit`), si es graficable (`is_graphable`), y observaci√≥n (`observation`).

> üîç **Nota:** Al guardar el formulario **no se copian referencias** a `form_template_concepts`.  
> En su lugar, se clona la informaci√≥n textual del concepto.  
> Esto garantiza que si la plantilla cambia en el futuro, los formularios viejos **no se vean afectados** (independencia hist√≥rica).

---

### 3Ô∏è‚É£ Modificaci√≥n o versionado del formulario

#### Edici√≥n reciente (menos de 7 d√≠as)

- Se permite editar directamente el `filled_form` y sus `filled_form_values`.

#### Edici√≥n posterior (>7 d√≠as)

- El backend crea una **copia del formulario viejo**, lo guarda como un nuevo `filled_form` (para la misma cita) y permite editar esa copia.
- Se conserva el original como versi√≥n hist√≥rica.

> üìò Regla complementaria:  
> Este comportamiento se refuerza con la propuesta de `template_version` y `template_snapshot` del archivo `01_formularios_clinicos_rules.md`, que permite reconstruir exactamente c√≥mo era la plantilla usada al llenar cada formulario.

---

### 4Ô∏è‚É£ Evoluci√≥n en el tiempo

El sistema puede graficar la evoluci√≥n de ciertos conceptos (por ejemplo ‚ÄúPeso‚Äù, ‚ÄúCintura‚Äù) usando todos los `filled_form_values` con `is_graphable = true` de un mismo paciente, ordenados por fecha de cita (`bookings.booking_date`).

```sql
SELECT
  ffv.concept_name,
  ffv.value_number AS value,
  b.booking_date
FROM filled_form_values ffv
JOIN filled_forms f ON f.id = ffv.filled_form_id
JOIN bookings b ON b.id = f.booking_id
WHERE f.user_id = :patientId
  AND ffv.is_graphable = 1
ORDER BY b.booking_date ASC;
```

---

## üß± ¬øQu√© es un template entonces?

Un **template de formulario cl√≠nico** es un conjunto de **conceptos definidos por un especialista (o por Multinature)** que sirve como **base estructural** para capturar valores en formularios reales.

> Los formularios reales (`filled_forms`) son **instancias** de un template, **llenas con datos de un paciente en una cita espec√≠fica**.

Cada formulario puede considerarse un **snapshot cl√≠nico puntual** dentro de la evoluci√≥n del paciente.

---

## ‚öôÔ∏è L√≥gica resumida de tablas

| Tabla                    | Prop√≥sito                                         | Claves principales                                                                                   |
| ------------------------ | ------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| `concepts`               | Cat√°logo base de conceptos cl√≠nicos reutilizables | `id`, `name`, `field_type`, `description`                                                            |
| `form_templates`         | Plantillas creadas por especialista o globales    | `id`, `specialty_id`, `specialist_id`, `version`, `is_initial_assessment`                            |
| `form_template_concepts` | Asociaci√≥n de conceptos dentro de una plantilla   | `form_template_id`, `concept_id`, `custom_name`, `unit`, `is_graphable`                              |
| `filled_forms`           | Formularios llenados en una cita                  | `booking_id`, `user_id`, `specialist_id`, `template_version`, `filled_by`                            |
| `filled_form_values`     | Respuestas individuales de cada campo             | `filled_form_id`, `concept_id`, `concept_name`, `value`, `unit`, `is_graphable`, `group_description` |

---

## üß© Reglas operativas y casos especiales

1. **Soft delete de plantillas**

   - `deleted_at` permite desactivar plantillas sin perder relaci√≥n con formularios antiguos.

2. **Clonaci√≥n / herencia**

   - `base_template_id` permite crear versiones derivadas o personalizadas de una plantilla global.

3. **Campos personalizados**

   - Si un concepto no existe en `concepts`, puede guardarse con `custom_name` sin `concept_id`.

4. **Responsabilidad compartida (paciente/especialista)**

   - A nivel funcional, el sistema puede usar el campo `filled_by` (ver reglas en `01_formularios_clinicos_rules.md`) para distinguir si el formulario fue llenado por el paciente, el especialista o ambos.

5. **Integraci√≥n con dietAgent**
   - Cada `concept_id` sirve como identificador sem√°ntico estable para que el agente interprete informaci√≥n cl√≠nica a lo largo del tiempo.
   - `field_type`, `value_number`, `value_json` y `is_graphable` permitir√°n construir contextos estructurados para inferencia y an√°lisis evolutivo.

---

## ‚úÖ Resumen visual del flujo

```mermaid
flowchart TD
  A[Creaci√≥n de template<br>(form_templates)] --> B[Definici√≥n de preguntas<br>(form_template_concepts)]
  B --> C[Selecci√≥n de paciente y cita<br>(bookings)]
  C --> D[Llenado del formulario<br>(filled_forms + filled_form_values)]
  D --> E[Visualizaci√≥n / Gr√°ficas<br>(is_graphable = true)]
  E --> F[DietAgent / Reportes]
```

---

## üìé Referencias cruzadas

- **Complementa:** [`01_formularios_clinicos_rules.md`](./01_formularios_clinicos_rules.md)
- **Depende de:** entidades `users`, `bookings`, `specialties`
- **Relevante para:** `forms-api`, `dietAgent`, `reports-api`
