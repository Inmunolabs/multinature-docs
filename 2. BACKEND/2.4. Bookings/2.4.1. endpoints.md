# Endpoints de Bookings API

Endpoints principales para la gestión de citas (bookings)

## Contenido

1. [Endpoints](#introducción)
   1. [Crear cita](#crear-cita)
   2. [Liquidar cita]
   3. [Editar cita]

---

## Endpoints

### Crear cita

```
POST /bookings/
```

#### Descripción

Crea una nueva cita entre un usuario y un especialista. Si la cita requiere pago, se procesa el pago correspondiente. Al finalizar, retorna solo la nueva cita.

### Parámetros obligatorios (body)

- `specialistId` (UUID): Identificador único del especialista.
- `userId` (UUID): Identificador único del usuario.
- `specialtyId` (UUID): Identificador único de la especialidad que será atendida en la cita.
- `date` (string, ISO 8601): Fecha de la cita (YYYY-MM-DD).
- `startHour` (string, HH:MM): Hora de inicio.
- `endHour` (string, HH:MM): Hora de fin.
- `amount` (number): Monto a pagar (anticipo o total). **Solo obligatorio si el especialista requiere pago**
- `type` (string): Tipo de pago, uno entre: '_openpayCard_', '_openpayStore_', '_mercadoPago_' o '_cash_'. **Solo obligatorio si el especialista requiere pago**
- `deviceSessionId` (string): Identificador de la sesión del dispositivo de Openpay. **Solo requerido cuando el usuario esta creando la cita junto con el pago del anticipo**
- `paymentMethodId` (UUID): Identificador del método de pago. **Solo requerido cuando el usuario esta creando la cita junto con el pago del anticipo**
- `cvv` (string): Card Verification Value. Código de seguridad de la tarjeta. **Solo requerido cuando el usuario esta creando la cita junto con el pago del anticipo**

### Parámetros opcionales (body)

- `addressId` (UUID): ID de la dirección.
- `videoCallUrl` (string, URL): Enlace de videollamada.
- `notes` (string): Notas adicionales.
- `description` (string): Descripción del pago.

### Validaciones principales

- Todos los IDs deben ser UUID válidos.
- `date` debe estar en formato ISO 8601 (YYYY-MM-DD) y ser una fecha futura.
- `startHour` y `endHour` deben estar en formato HH:MM y `endHour` debe ser mayor que `startHour`.
- Si se requiere pago, `amount` debe estar entre el anticipo y el precio de la consulta definidos por el especialista.
- El tipo de pago debe ser válido según los métodos soportados.

### Ejemplo de petición

Petición para cita creada por un especialista

```json
{
  "specialistId": "eb003fcf-fcf1-4da0-b003-35afd7198844",
  "userId": "f0d8e32b-e4bb-4e08-ae48-6c9b96a3a98f",
  "specialtyId": "123456",
  "date": "2025-12-08",
  "startHour": "16:00",
  "endHour": "17:30",
  "notes": "Cita agendada por el especialista",
  "type": "card",
  "amount": 500,
  "addressId": "opcional"
}
```

Cuando la petición incluye el pago con tarjeta del anticipo de la cita (para confirmar la cita) se deben concatenar los siguientes campos al objeto body de la solicitud:

```json
{
  "deviceSessionId": "YYXX1Ku4zPv0e1i07jmfryyMr10PU0ja",
  "paymentMethodId": "7900836f-a416-4ac0-a839-9ab4bb15cc96",
  "description": "Pago de liquidación de consulta",
  "cvv": "123"
}
```

### Ejemplo de respuesta

```json
{
  "folio": "a57fffa4-f4be-4fef-bb13-bb7ed13c92f4",
  "message": "Cita creada.",
  "content": {
    "id": "ef71a421-a3d5-4a5a-bb1f-44edb916aaad",
    "user": {
      "name": "Samuel rename Update"
    },
    "specialist": {
      "name": "Samuel Prueba de update"
    },
    "specialty": "Nutricionista",
    "address": "Calle de prueba 333 Int. 1, Col. Mi colonia, Zapopan, Jalisco, 45138, México. Referencia: Esta dirección es la ostia update",
    "videoCallUrl": "",
    "status": "Por confirmar",
    "date": "2025-12-03T00:00:00.000Z",
    "startHour": "17:00:00",
    "endHour": "17:30:00",
    "notes": "Cita agendada por el especialista",
    "isPaid": false,
    "advancePayment": {
      "id": "9d6a769d-a48a-46be-a954-1c1e258e09e4",
      "iva": 56,
      "subtotal": 294,
      "total": 350,
      "type": "mercadoPago",
      "name": "Consulta",
      "status": "Confirmando el Pago",
      "paymentMethod": "https://sandbox.mercadopago.com.mx/checkout/v1/redirect?pref_id=2482350288-f58c688d-a6e2-4bb5-baf3-5d51bc2bb5d4",
      "folio": "202506120003",
      "purchaseDate": "2025-06-12"
    },
    "liquidationPayment": {}
  }
}
```

---

## 2. Liquidar Booking

### Endpoint

```
POST /bookings/liquidate/:id
```

### Descripción

Permite liquidar el pago pendiente de una cita ya creada. Al liquidar, retorna todas las citas del usuario o especialista.
El amount solo se pone si el pago es de anticipo de la cita, si es pago de liquidación, se ignorará el amount y se cobrará el faltante.

### Parámetros obligatorios (body)

- `type` (string): Tipo de pago (`card`, `cash`, etc). **Obligatorio**

### Ejemplo de petición

```json
{
  "type": "openpayCard",
  "deviceSessionId": "YYXX1Ku4zPv0e1i07jmfryyMr10PU0ja",
  "paymentMethodId": "7900836f-a416-4ac0-a839-9ab4bb15cc96",
  "description": "Pago de liquidación de consulta",
  "cvv": "123"
  //"amount": 250
}
```

### Ejemplo de respuesta

Igual que en el endpoint de creación, retorna el listado de bookings actualizado.

---

# 3. Editar Booking (Actualizar Cita)

Este endpoint permite actualizar los datos de una cita existente. Solo pueden editar la cita el usuario o el especialista involucrado.

---

## Endpoint

```
PATCH /bookings/:id
```

## Descripción

Actualiza los datos de una cita existente. Permite modificar fecha, hora, notas, dirección, enlace de videollamada y otros campos permitidos. No se puede editar una cita ya cancelada o finalizada.

## Parámetros obligatorios

- `id` (string, UUID): ID de la cita a editar (en la URL).

## Parámetros permitidos en el body

- `date` (string, ISO 8601): Nueva fecha de la cita (YYYY-MM-DD).
- `startHour` (string, HH:MM): Nueva hora de inicio.
- `endHour` (string, HH:MM): Nueva hora de fin.
- `addressId` (string, UUID): Nuevo ID de dirección.
- `videoCallUrl` (string, URL): Nuevo enlace de videollamada.
- `notes` (string): Nuevas notas.
- `status` (string): Nuevo estatus de la cita (solo ciertos valores permitidos, por ejemplo: "Por confirmar", "Confirmada", "Cancelada").

## Validaciones principales

- El `id` debe ser un UUID válido.
- Si se envía `date`, debe estar en formato ISO 8601 y ser una fecha futura.
- Si se envía `startHour` o `endHour`, deben estar en formato HH:MM y `endHour` debe ser mayor que `startHour`.
- Si se envía `addressId`, debe ser un UUID válido.
- Si se envía `videoCallUrl`, debe ser una URL válida.
- Si se cambia el `status` a "Cancelada", debe incluirse la razón de cancelación en `notes`.

## Ejemplo de petición

```json
{
  "date": "2025-12-10",
  "startHour": "14:00",
  "endHour": "15:00",
  "addressId": "c1b2a3d4-e5f6-7890-abcd-1234567890ef",
  "videoCallUrl": "https://meet.example.com/abc123",
  "notes": "Cambio de horario por disponibilidad",
  "status": "Por confirmar"
}
```

## Ejemplo de respuesta

```json
{
  "folio": "b12fffa4-f4be-4fef-bb13-bb7ed13c92f4",
  "message": "Cita actualizada.",
  "content": [
    {
      "id": "074b388a-7632-4829-8fc5-5e9ea913929f",
      "specialistId": "eb003fcf-fcf1-4da0-b003-35afd7198844",
      "userId": "f0d8e32b-e4bb-4e08-ae48-6c9b96a3a98f",
      "specialty": "Nutricionista",
      "address": "",
      "videoCallUrl": "https://meet.example.com/abc123",
      "status": "Por confirmar",
      "date": "2025-12-10T00:00:00.000Z",
      "startHour": "14:00:00",
      "endHour": "15:00:00",
      "notes": "Cambio de horario por disponibilidad"
    }
    // ...más citas si aplica
  ]
}
```

---

## Notas

- Solo el usuario o especialista involucrado pueden editar la cita.
- No se puede editar una cita ya cancelada o finalizada.
- El campo `folio` es un identificador único de la operación.
- El campo `message` describe el resultado de la operación.
