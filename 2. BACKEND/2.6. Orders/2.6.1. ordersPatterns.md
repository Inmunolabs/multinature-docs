
# üìÑ Documentaci√≥n T√©cnica: Patr√≥n de √ìrdenes y Webhooks

Este archivo describe el funcionamiento del **c√≥digo** involucrado en los endpoints de creaci√≥n de √≥rdenes y recepci√≥n de webhooks de pago. No se documenta el comportamiento de las rutas externas, sino la l√≥gica interna, clases, m√©todos y relaciones.

---

## üîÅ Webhooks de Pagos

### üè¶ MercadoPagoStrategy

**Archivo:** `PaymentMethodsStrategies.js`

- M√©todo `validate(req)`:
  - Extrae `id` y `topic` de `req.query`.
  - Realiza un fetch a la API de MercadoPago con el `id` de pago.
  - Recupera el `external_reference` para buscar la orden en la BD.
  - Construye un objeto con detalles del pago y la orden para usar aguas abajo.

- M√©todo `confirm(data, req, awsRequestId)`:
  - Comprueba si el `status_detail` es `accredited`.
  - Si es as√≠ y a√∫n no estaba acreditado en BD:
    - Se obtiene el usuario y constantes.
    - Se ejecuta `safeProccessConsumptionsAndCommissions()`.
    - Se env√≠a correo con estrategia `EmailNotificationStrategy` si es orden tipo tienda.
  - Actualiza el estado de `paymentProvider` en BD.

### üè™ OpenpayStrategy

**Archivo:** `PaymentMethodsStrategies.js`

- M√©todo `validate(req)`:
  - Extrae `transaction` de `req.body`.
  - Determina si es suscripci√≥n o pago √∫nico.
  - Si es orden: busca por `transaction.id` en BD y retorna orden.
  - Si es suscripci√≥n: prepara info de `subscriptionId` y `transaction`.

- M√©todo `confirm(data, req, awsRequestId)`:
  - Si es tipo `order`: llama a `#handleOrderPayment(order, transaction, awsRequestId)`.
  - Si es `subscription`: ejecuta `#handleSubscriptionPayment(transaction)`.

- `#handleOrderPayment`: procesa orden de Openpay, verifica `status`, ejecuta l√≥gica de consumo y correos.
- `#handleSubscriptionPayment`: construye un `req` simulado y usa `OrderFactory` para generar la orden recurrente.

---

## üõ†Ô∏è Creaci√≥n de √ìrdenes

### üß± OrderFactory

**Archivo:** `OrderFactory.js`

- M√©todo `createOrder(type, req)`:
  - Devuelve instancia de clase hija (`OpenpayCardOrder`, `OpenpayStoreOrder`, etc.) seg√∫n tipo.
- M√©todo `updateOrder(type)`:
  - Retorna clase est√°tica de orden actualizable (solo `store`).

### üßæ OrderTemplate (Clase Base)

**Archivo:** `OrderTemplate.js`

- Constructor:
  - Inicializa `orderDB` con datos de usuario, direcci√≥n, fecha estimada de entrega, etc.
- `create(req)`:
  - Ejecuta en orden:
    - `_updateProductsAndGetTotal()` para validar productos y precios.
    - `_createPayOrder()` para ejecutar l√≥gica de pago.
    - `_setOrderFolio()` para generar identificador √∫nico.
    - `_updates()` para guardar orden, actualizar stock y eliminar carrito.
    - `_responseData()` para devolver respuesta.

- `_createPayOrder()`:
  - Usa `PaymentMethodFactory.parseReqToMethod()` y `.createPaymentMethod()`.
  - El m√©todo `.pay()` se llama sobre la instancia generada.

- `_updates()`:
  - Guarda en BD (`OrdersQueries.add`).
  - Llama a `_updateProductStock()` y `_specificFunctionsFromPaymentMethodType()`.
  - Envia notificaci√≥n por correo con `_sendNotification()`.

- `_specificFunctionsFromPaymentMethodType()`:
  - M√©todo abstracto sobrescrito por subclases (ver abajo).

### üß© Subclases de Orden

**Archivo:** `OrderMethods.js`

- `OpenpayCardOrder`:
  - Llama a `safeProccessConsumptionsAndCommissions()` si el pago fue `completed`.
- `OpenpayStoreOrder`:
  - Sube archivo PDF con referencia de pago a S3.
- `MercadoPagoOrder`:
  - Llama a `mercadoPago.createOrderURL()` y guarda preferencia.
- `SubscriptionOrder`:
  - L√≥gica similar a `card`, usa `transaction` existente.

---

## üí≥ M√©todos de Pago

**Archivo:** `PaymentMethodFactory.js`

- `parseReqToMethod()`:
  - Mapea el `req` y datos adicionales a un objeto seg√∫n tipo.
- `createPaymentMethod()`:
  - Devuelve una instancia de m√©todo (`OpenpayCardPaymentMethod`, etc.).
- `handlePaymentResponse()`:
  - Define c√≥mo almacenar el `paymentProvider` en la orden, y si debe cambiar el tipo.

**Archivo:** `PaymentMethods.js`

- Cada clase implementa `.pay(order)` y `.toString(order)`.
- Casos como `OpenpayCardPaymentMethod` hacen update del CVV antes de lanzar la orden.
- `MercadoPagoPaymentMethod` retorna `false`, delegando la creaci√≥n a otro punto del sistema.

---

## üîÑ Confirmaci√≥n de Webhooks

**Archivo:** `update.js`

- `confirmPayment(provider)`:
  - Recupera la estrategia de pago v√≠a `getPaymentStrategy()`.
  - Llama a `.confirm()` con `paymentStrategyData`, `req`, `awsRequestId`.
  - Devuelve respuesta con estado actualizado.

---

